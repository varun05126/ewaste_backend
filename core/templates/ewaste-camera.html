<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Waste AI Detection</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            text-align: center;
            padding: 20px;
        }

        h1 {
            font-size: 32px;
            margin-bottom: 5px;
        }

        #video-box {
            background: white;
            width: 420px;
            margin: auto;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0px 3px 10px rgba(0,0,0,0.15);
        }

        video {
            width: 100%;
            border-radius: 10px;
        }

        /* ITEM SELECT DROPDOWN */
        #item-select {
            width: 100%;
            padding: 12px;
            margin-top: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 2px solid #ddd;
            font-size: 16px;
            background: white;
            cursor: pointer;
            font-weight: bold;
        }

        #item-select:focus {
            outline: none;
            border-color: #222;
        }

        .detect-btn {
            margin-top: 10px;
            background: #222;
            padding: 12px 22px;
            border-radius: 8px;
            color: white;
            font-size: 18px;
            cursor: pointer;
            border: none;
            width: 100%;
            font-weight: bold;
        }

        .detect-btn:hover {
            background: #444;
        }

        .detect-btn:disabled {
            background: #999;
            cursor: not-allowed;
        }

        /* RESULT BOX */
        .ewaste-box {
            background: #28a745;
            color: #fff;
            padding: 18px;
            border-radius: 10px;
            width: 280px;
            margin: 20px auto;
            font-size: 22px;
            font-weight: bold;
        }

        .not-ewaste-box {
            background: #dc3545;
            color: #fff;
            padding: 18px;
            border-radius: 10px;
            width: 280px;
            margin: 20px auto;
            font-size: 22px;
            font-weight: bold;
        }

        .waiting-box {
            background: #ffc107;
            color: #333;
            padding: 18px;
            border-radius: 10px;
            width: 280px;
            margin: 20px auto;
            font-size: 22px;
            font-weight: bold;
        }

        #autoToggle {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        #auto-label {
            font-size: 18px;
            margin-left: 8px;
            font-weight: bold;
        }

        #object-name {
            font-size: 18px;
            color: #555;
            margin-top: 15px;
            font-weight: bold;
        }

        .info-text {
            color: #666;
            font-size: 14px;
            margin-top: 10px;
        }
    </style>
</head>

<body>

    <h1>E-Waste AI Detection</h1>
    <p id="subtext">Select an item and click detect</p>

    <!-- AUTO-DETECT TOGGLE -->
    <div style="margin-bottom: 20px;">
        <input type="checkbox" id="autoToggle">
        <label id="auto-label">Auto Detect (requires item selected)</label>
    </div>

    <!-- CAMERA AREA -->
    <div id="video-box">
        <video id="camera" autoplay></video>

        <!-- ITEM SELECT DROPDOWN -->
        <select id="item-select">
            <option value="">-- Select Item Type --</option>
            <option value="phone">üì± Phone/Mobile</option>
            <option value="charger">üîå Charger</option>
            <option value="laptop">üíª Laptop</option>
            <option value="tablet">üì≤ Tablet</option>
            <option value="headphones">üéß Headphones</option>
            <option value="keyboard">‚å®Ô∏è Keyboard</option>
            <option value="mouse">üñ±Ô∏è Mouse</option>
            <option value="monitor">üñ•Ô∏è Monitor</option>
            <option value="cable">üîó Cable</option>
            <option value="battery">üîã Battery</option>
            <option value="powerbank">‚ö° PowerBank</option>
            <option value="speaker">üîä Speaker</option>
            <option value="camera">üì∑ Camera</option>
            <option value="earbuds">üéµ Earbuds</option>
            <option value="adapter">üîå Adapter</option>
            <option value="remote">üì° Remote</option>
            <option value="webcam">üìπ Webcam</option>
        </select>

        <button class="detect-btn" id="detectButton">Manual Detect</button>
        <p class="info-text">Select an item above, then click detect</p>
    </div>

    <!-- RESULT -->
    <div id="result-box" class="waiting-box">Waiting...</div>
    <div id="object-name">Object: ‚Äî</div>

    <!-- Hidden canvas -->
    anvas id="hiddenCanvas" style="display:none;"></canvas>

<script>
////////////////////////////////////////////////////////////////////////////////
//  AUDIO UNLOCK ‚Äî REQUIRED FOR SAFARI & CHROME
////////////////////////////////////////////////////////////////////////////////
document.body.addEventListener("click", function enableAudio() {
    let a1 = document.getElementById("sound-detect");
    let a2 = document.getElementById("sound-ewaste");
    let a3 = document.getElementById("sound-not-ewaste");

    if (a1) a1.play().catch(()=>{});
    if (a2) a2.play().catch(()=>{});
    if (a3) a3.play().catch(()=>{});

    document.body.removeEventListener("click", enableAudio);
});

////////////////////////////////////////////////////////////////////////////////
//  CAMERA STREAM
////////////////////////////////////////////////////////////////////////////////

const video = document.getElementById("camera");
navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => video.srcObject = stream)
    .catch(err => {
        console.error("Camera error:", err);
        alert("Camera access denied. Please allow camera permission.");
    });

// AUTO DETECT CONTROL
let autoMode = false;
let autoInterval = null;

document.getElementById("autoToggle").addEventListener("change", function () {
    autoMode = this.checked;

    if (autoMode) {
        const selectedItem = document.getElementById("item-select").value;
        if (!selectedItem) {
            alert("Please select an item first!");
            this.checked = false;
            autoMode = false;
            return;
        }
        document.getElementById("subtext").innerText = "Auto-detecting every 1 second...";
        startAutoDetect();
    } else {
        document.getElementById("subtext").innerText = "Manual mode enabled";
        stopAutoDetect();
    }
});

function startAutoDetect() {
    stopAutoDetect();
    autoInterval = setInterval(() => {
        captureAndSend();
    }, 1000);
}

function stopAutoDetect() {
    if (autoInterval) {
        clearInterval(autoInterval);
        autoInterval = null;
    }
}

// Manual Detect
document.getElementById("detectButton").addEventListener("click", () => {
    const selectedItem = document.getElementById("item-select").value;
    
    if (!selectedItem) {
        alert("Please select an item first!");
        return;
    }
    
    captureAndSend();
});

////////////////////////////////////////////////////////////////////////////////
// CAPTURE FRAME + SEND WITH SELECTED ITEM
////////////////////////////////////////////////////////////////////////////////

function captureAndSend() {
    const canvas = document.getElementById("hiddenCanvas");
    const selectedItem = document.getElementById("item-select").value;

    if (!selectedItem) {
        console.warn("No item selected, skipping detection");
        return;
    }

    if (!video.videoWidth || !video.videoHeight) {
        console.warn("Video not ready yet");
        return;
    }

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0);

    const imageData = canvas.toDataURL("image/jpeg");

    // Build form data
    let bodyData = "image=" + encodeURIComponent(imageData);
    bodyData += "&item=" + encodeURIComponent(selectedItem);

    fetch("/api/camera-detect/", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: bodyData
    })
    .then(res => res.json())
    .then(data => {
        console.log("Response:", data);
        updateUI(data.detected, data.caption, selectedItem);
    })
    .catch(err => {
        console.error("Error:", err);
        updateUI("error", "connection_error", selectedItem);
    });
}

////////////////////////////////////////////////////////////////////////////////
// UI UPDATE + SOUND
////////////////////////////////////////////////////////////////////////////////

function updateUI(result, caption, itemName) {
    const box = document.getElementById("result-box");
    const name = document.getElementById("object-name");

    if (!caption) caption = itemName || "unknown";

    // Always play "object detected" sound
    try {
        let audio = document.getElementById("sound-detect");
        if (audio) audio.play().catch(()=>{});
    } catch (e) {}

    if (result === "ewaste") {
        box.className = "ewaste-box";
        box.innerHTML = "‚ôªÔ∏è EWASTE ‚úî";

        try {
            let audio = document.getElementById("sound-ewaste");
            if (audio) audio.play().catch(()=>{});
        } catch (e) {}
    } else if (result === "error") {
        box.className = "waiting-box";
        box.innerHTML = "‚ö†Ô∏è ERROR";
        name.innerText = `Object: ${itemName}`;
    } else {
        box.className = "not-ewaste-box";
        box.innerHTML = "‚ùå NOT EWASTE";

        try {
            let audio = document.getElementById("sound-not-ewaste");
            if (audio) audio.play().catch(()=>{});
        } catch (e) {}
    }

    name.innerText = `Object: ${caption}`;
}
</script>

<!-- AUDIO FILES (optional - if missing, app still works) -->
<audio id="sound-detect" src="/static/sounds/object_detected.mp3"></audio>
<audio id="sound-ewaste" src="/static/sounds/ewaste.mp3"></audio>
<audio id="sound-not-ewaste" src="/static/sounds/not_ewaste.mp3"></audio>

</body>
</html>
